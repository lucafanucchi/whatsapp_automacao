<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Conectar WhatsApp</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f2f5; }
        #qrcode-container { width: 300px; height: 300px; border: 1px solid #ccc; background-color: white; display: flex; align-items: center; justify-content: center; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #status { font-size: 1.2em; margin-top: 20px; font-weight: bold; }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
</head>
<body>

    <h1>Conectar ao WhatsApp</h1>
    <div id="qrcode-container">
        <div id="status">Aguardando QR Code do servidor...</div>
    </div>
    
    <script>
        // =============================================================================
        // ATENÇÃO! Cole aqui a URL do seu GATEWAY implantado no Render.
        // =============================================================================
        const GATEWAY_URL = "https://whatsapp-gateway-a9iz.onrender.com";

        const statusDiv = document.getElementById('status');
        const qrContainer = document.getElementById('qrcode-container');
        let qrCode = null; // Para guardar a instância do QRCode

        async function verificarConexao() {
            try {
                const response = await fetch(`${GATEWAY_URL}/status`);
                const data = await response.json();

                if(data.connected) {
                    statusDiv.textContent = '✅ Conectado com sucesso!';
                    qrContainer.innerHTML = ''; // Limpa o QR Code
                    qrContainer.appendChild(statusDiv);
                    // Para de verificar quando já está conectado
                    return true; 
                }
                return false;
            } catch (e) {
                statusDiv.textContent = '❌ Não foi possível conectar ao servidor do gateway.';
                return false;
            }
        }


        async function buscarQrCode() {
            if (await verificarConexao()) return;

            try {
                const response = await fetch(`${GATEWAY_URL}/qr-code`);
                if(response.ok) {
                    const data = await response.json();
                    
                    // Limpa o container e renderiza o novo QR Code
                    qrContainer.innerHTML = ''; 
                    statusDiv.textContent = '';
                    
                    // Usa a biblioteca QRCode.js para gerar a imagem
                    qrCode = new QRCode(qrContainer, {
                        text: data.qr,
                        width: 300,
                        height: 300,
                    });

                } else {
                    statusDiv.textContent = 'Aguardando QR Code... Verifique os logs do gateway no Render.';
                }
            } catch (e) {
                 statusDiv.textContent = '❌ Erro ao buscar QR Code. Verifique se o gateway está no ar.';
            }
        }

        // Começa a verificar o status e buscar o QR Code a cada 5 segundos
        setInterval(async () => {
             await buscarQrCode();
        }, 5000);

        // Busca pela primeira vez imediatamente ao carregar a página
        buscarQrCode();
    </script>
</body>
</html>